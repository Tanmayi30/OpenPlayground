<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Virtual Guitar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .instructions {
            background: rgba(0, 0, 0, 0.75);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        h1 { margin: 0 0 10px 0; font-size: 1.5rem; color: #f0a500; }
        p { margin: 5px 0; font-size: 0.9rem; opacity: 0.9; }

        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        #interaction-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #f0a500;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="loading-screen">Loading Playable 3D Guitar...</div>
    <div id="interaction-prompt">Click the strings to play!</div>

    <div id="ui-container">
        <div class="instructions">
            <h1>Playable 3D Guitar</h1>
            <p>• <b>Click Strings</b> to Pluck</p>
            <p>• <b>Drag Background</b> to Rotate</p>
            <p>• <b>Scroll</b> to Zoom</p>
        </div>
    </div>

    <script>
        let scene, camera, renderer, guitar;
        let isMouseDown = false;
        let targetRotationX = 0.3;
        let targetRotationY = -0.5;
        let zoom = 12;
        
        // Interaction
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let strings = [];
        let audioCtx = null;

        // Frequencies for standard EADGBE tuning
        const stringFrequencies = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63];

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playStringSound(index) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // Simple Karplus-Strong style approximation using a sawtooth and a lowpass
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(stringFrequencies[index], audioCtx.currentTime);

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(2000, audioCtx.currentTime);
            filter.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 1.5);

            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + 1.5);
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x121212);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = zoom;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const spotLight = new THREE.SpotLight(0xffffff, 1);
            spotLight.position.set(10, 20, 10);
            spotLight.castShadow = true;
            scene.add(spotLight);

            createGuitar();

            window.addEventListener('resize', onWindowResize, false);
            
            // Interaction events
            renderer.domElement.addEventListener('mousedown', onDocumentMouseDown);
            document.addEventListener('mouseup', () => isMouseDown = false);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('wheel', onMouseWheel);

            const loading = document.getElementById('loading-screen');
            if (loading) loading.style.opacity = '0';
            setTimeout(() => loading.remove(), 500);

            animate();
        }

        function createGuitar() {
            guitar = new THREE.Group();

            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x8b4513, roughness: 0.3, metalness: 0.1 });
            const neckMat = new THREE.MeshStandardMaterial({ color: 0x3d1f05, roughness: 0.8 });
            const fretMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, metalness: 0.8, roughness: 0.2 });
            const stringMat = new THREE.MeshStandardMaterial({ color: 0xdddddd, metalness: 0.9, roughness: 0.1 });

            // Main Body
            const upperBody = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.8, 1, 32), bodyMat);
            upperBody.position.y = 1;
            upperBody.rotation.x = Math.PI / 2;
            guitar.add(upperBody);

            const lowerBody = new THREE.Mesh(new THREE.CylinderGeometry(2.2, 2.2, 1, 32), bodyMat);
            lowerBody.position.y = -1;
            lowerBody.rotation.x = Math.PI / 2;
            guitar.add(lowerBody);

            // Sound Hole
            const hole = new THREE.Mesh(new THREE.CircleGeometry(0.6, 32), new THREE.MeshBasicMaterial({ color: 0x000000 }));
            hole.position.set(0, 0.6, 0.51);
            guitar.add(hole);

            // Neck
            const neck = new THREE.Mesh(new THREE.BoxGeometry(0.7, 5, 0.3), neckMat);
            neck.position.y = 4.5;
            neck.position.z = 0.3;
            guitar.add(neck);

            // Headstock
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.9, 1.2, 0.3), neckMat);
            head.position.y = 7.5; head.position.z = 0.4; head.rotation.x = -0.1;
            guitar.add(head);

            // Bridge
            const bridge = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.3, 0.2), neckMat);
            bridge.position.set(0, -0.8, 0.5);
            guitar.add(bridge);

            // Strings (Interactive)
            const stringPositions = [-0.25, -0.15, -0.05, 0.05, 0.15, 0.25];
            stringPositions.forEach((x, i) => {
                // We use a slightly thicker hit box for easier clicking
                const strGeom = new THREE.CylinderGeometry(0.02, 0.02, 8.5, 8);
                const str = new THREE.Mesh(strGeom, stringMat.clone());
                str.position.set(x, 3.3, 0.48);
                str.userData = { stringIndex: i, originalX: x };
                strings.push(str);
                guitar.add(str);
            });

            scene.add(guitar);
        }

        function onDocumentMouseDown(event) {
            initAudio();
            
            // Calculate mouse position
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(strings);

            if (intersects.length > 0) {
                const pluckedString = intersects[0].object;
                const idx = pluckedString.userData.stringIndex;
                
                // Visual feedback (vibration)
                pluckedString.material.emissive.setHex(0x555555);
                setTimeout(() => pluckedString.material.emissive.setHex(0x000000), 100);
                
                playStringSound(idx);
            } else {
                isMouseDown = true;
            }
        }

        function onMouseMove(event) {
            if (isMouseDown) {
                targetRotationY += event.movementX * 0.005;
                targetRotationX += event.movementY * 0.005;
            }
            
            // Hover effect for strings
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(strings);
            document.body.style.cursor = intersects.length > 0 ? 'pointer' : 'default';
        }

        function onMouseWheel(event) {
            zoom += event.deltaY * 0.01;
            zoom = Math.max(5, Math.min(25, zoom));
            camera.position.z = zoom;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            guitar.rotation.y += (targetRotationY - guitar.rotation.y) * 0.1;
            guitar.rotation.x += (targetRotationX - guitar.rotation.x) * 0.1;

            // Small vibration animation for strings
            const time = Date.now() * 0.05;
            strings.forEach(s => {
                if (s.material.emissive.r > 0) {
                    s.position.x = s.userData.originalX + Math.sin(time) * 0.02;
                } else {
                    s.position.x = s.userData.originalX;
                }
            });

            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>